'シート上に表示しているボタン'

sheet1(form)

Option Explicit

    Sub UserForm()

    'ユーザーフォームを開く'
    frmPoint.Show

    End Sub

    Sub OpenForm()

    'ユーザーフォームを開く'
    frmView.Show

    End Sub



'登録フォーム内のプログラム'

Option Explicit

'SQLiteデータベースへの接続をグローバルで宣言

Dim conn As Object


    Sub openDB()
        ' SQLiteデータベースへの接続文字列を指定します。
        Dim connectionString As String
        connectionString = "DRIVER=SQLite3 ODBC Driver;Database=C:\Users\7d03\Desktop\vba\character.db"

        ' ADODB.Connection オブジェクトを作成します。
        Set conn = CreateObject("ADODB.Connection")

        ' データベースに接続します。
        conn.Open connectionString
    End Sub


    Sub closeDB()

    'DBのクローズ処理'
    conn.Close

    '初期化'
    Set conn = Nothing

    End Sub

    'DB登録処理'

    Sub insertDB(ByVal name As String, ByVal point As  String, ByVal cpoint As String)
     'SQL文を格納するsql'
     Dim sql As String
     sql = "INSERT INTO character(name,point,cpoint) VALUES('" & name & "','" & point & "','" & cpoint & "');"

     'DB接続処理'
     openDB
    
     'sqlの実行'
     conn.Execute sql

     '接続をクローズする'
     closeDB

    End Sub

 '登録ボタン'

 Private Sub Submit_Click()
    
     Dim name As String 'キャラクター名'
     Dim point As String 'キツイ所'
     Dim cpoint As String '対策'
    
     'テキストボックス内の値を取得'
     name = frmPoint.boxName.Text
     point = frmPoint.boxPoint.Text
     cpoint = frmPoint.boxCpoint.Text

     'insertDBに値を渡して登録処理'
     insertDB name, point, cpoint
    
     'メッセージを表示します。'
     MsgBox "SQLiteデータベースファイルを作成し、テーブルを作成しました。"
    
     Unload Me ' フォームを閉じる
    
 End Sub



'DB閲覧'

Option Explicit

'SQLiteデータベースへの接続をグローバルで宣言
Dim conn As Object

 Sub openDB()
     ' DBに接続する処理
     Dim connectionString As String
     connectionString = "DRIVER=SQLite3 ODBC Driver;Database=C:\Users\7d03\Desktop\vba\character.db"
     Set conn = CreateObject("ADODB.Connection")
     ' DBに接続。
     conn.Open connectionString
 End Sub


 Sub closeDB()
     ' オブジェクトが Nothing でないことを確認してからクローズ処理を実行
     If Not conn Is Nothing Then
        ' DBのクローズ処理
        conn.Close
        ' 初期化
        Set conn = Nothing
     End If
 End Sub


 Private Sub ListView_BeforeLabelEdit(Cancel As Integer)

     '表示するだけで何もしない'

 End Sub


 Private Sub SearchBtn_Click()
     ' 検索した文字でDB内のキャラクター名を検索
    
     ' 検索フォームに入力された文章
     Dim search As String
     ' searchBox内の文字をsearchに当て込む
     search = Me.searchBox.Text
    
     ' リストビューの内容をクリア
     Me.ListView.ListItems.Clear
    
     ' データベースに接続
     openDB
    
     ' 検索結果をリストビューに追加する
     Dim rs As Object
     Set rs = conn.Execute("SELECT * FROM character WHERE name = '" & search & "';")


     Do While Not rs.EOF
      ' 新しいリストビューアイテムを追加
         Dim newItem As ListItem
         Set newItem = Me.ListView.ListItems.Add(, , rs.Fields("name").Value)
         ' 各列に対応するサブアイテムを追加
         newItem.SubItems(1) = rs.Fields("point").Value
         newItem.SubItems(2) = rs.Fields("cpoint").Value
         ' 次のレコードに移動
         rs.MoveNext
     Loop
    
     ' レコードセットをクローズ
     rs.Close
    
     ' データベース接続をクローズ
     closeDB
    
     ' メッセージを表示します
     MsgBox "データベースからデータを取得しました"
 End Sub


 Private Sub UserForm_Initialize()
     ' ListView コントロールのカラムを設定します
     With Me.ListView
         .View = lvwReport ' レポートビュースタイル
         .ColumnHeaders.Clear ' 既存のカラムをクリア
         ' カラムを追加します
         .ColumnHeaders.Add , , "キャラクター名", 120
         .ColumnHeaders.Add , , "キツイ所", 120
         .ColumnHeaders.Add , , "対策", 120
     End With
 End Sub



 Private Sub UserForm_Terminate()
     ' フォームが閉じられるときにデータベース接続をクローズする
     closeDB
 End Sub

